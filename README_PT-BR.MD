# Pudim Server

Cria√ß√£o de servidores HTTP simples, leves e customiz√°veis

> [!WARNING]
> Projeto experimental. APIs podem mudar sem aviso.

üá∫üá∏ [Read in English](README.md)

## Sum√°rio

- [Sobre](#sobre)
- [Depend√™ncias](#depend√™ncias)
- [Como Come√ßar](#como-come√ßar)
  - [Instala√ß√£o](#instala√ß√£o)
  - [Criando o Servidor](#criando-o-servidor)
  - [Criando Rotas](#criando-rotas)
  - [Iniciando o Servidor](#iniciando-o-servidor)
  - [Objeto Request](#objeto-request)
  - [Objeto Response](#objeto-response)
- [CORS](#cors)
- [Pipeline](#pipeline)
- [Cache](#cache)
- [Exemplo Completo](#exemplo-completo)
- [Exemplos](#exemplos)
- [Roadmap](#roadmap)
- [Licen√ßa](#licen√ßa)
- [Contribuindo](#contribuindo)

## Sobre

Pudim Server √© uma lib Lua focada em fornecer APIs simples para cria√ß√£o de servidores web com um sistema de rotas. Feito para aceitar requisi√ß√µes HTTP, interpret√°-las, despachar para um handler e devolver uma resposta.

Essa lib est√° sendo projetada com base no que [Davi](https://github.com/pessoa736) entende de **servidor**. Ele pretende expandir a lib para algo mais complexo com o tempo, mas mantendo em foco a simplicidade, leveza e customiza√ß√£o.

## Depend√™ncias

- Lua >= 5.4
- LuaSocket
- lua-cjson
- loglua

## Como Come√ßar

### Instala√ß√£o

```sh
# Instala√ß√£o local
luarocks install PudimServer --local

# Instala√ß√£o global
sudo luarocks install PudimServer
```

### Criando o Servidor

```lua
local PudimServer = require("PudimServer")

local server = PudimServer:Create{
  ServiceName = "Meu Servi√ßo",
  Port = 8080,
  Address = "localhost"
}
```

Todos os campos s√£o opcionais. Padr√µes: `ServiceName = "Pudim Server"`, `Port = 8080`, `Address = "localhost"`.

### Criando Rotas

Handlers de rota recebem `(req, res)` e devem retornar `res:response(status, body, headers)`.

```lua
-- P√°gina HTML
server:Routes("/", function(req, res)
  if req.method == "GET" then
    return res:response(200, "<h1>Ol√°!</h1>", {["Content-Type"] = "text/html"})
  end
  return res:response(405, {error = "M√©todo n√£o permitido"})
end)

-- API JSON (tabelas s√£o auto-convertidas para JSON)
server:Routes("/api/users", function(req, res)
  if req.method == "GET" then
    return res:response(200, {
      {id = 1, name = "Jo√£o"},
      {id = 2, name = "Maria"}
    })
  end

  if req.method == "POST" then
    return res:response(201, {msg = "Usu√°rio criado!", data = req.body})
  end

  return res:response(405, {error = "M√©todo n√£o permitido"})
end)
```

### Iniciando o Servidor

```lua
server:Run()
```

### Objeto Request

| Propriedade | Tipo | Descri√ß√£o |
|-------------|------|-----------|
| `method` | string | M√©todo HTTP (GET, POST, PUT, DELETE, etc) |
| `path` | string | Caminho da requisi√ß√£o (ex: "/api/users") |
| `version` | string | Vers√£o do HTTP (ex: "HTTP/1.1") |
| `headers` | table | Headers da requisi√ß√£o (chaves em lowercase) |
| `body` | string | Corpo da requisi√ß√£o |

### Objeto Response

`res:response(status, body, headers)`:

| Par√¢metro | Tipo | Obrigat√≥rio | Descri√ß√£o |
|-----------|------|-------------|-----------|
| `status` | number | ‚úÖ | C√≥digo de status HTTP (200, 404, 500, etc) |
| `body` | string/table | ‚úÖ | Corpo da resposta. Tabelas s√£o auto-convertidas para JSON |
| `headers` | table | ‚ùå | Headers customizados da resposta |

## CORS

Habilite CORS com `EnableCors()`. Requisi√ß√µes preflight `OPTIONS` s√£o tratadas automaticamente.

```lua
-- Permitir todas as origens (padr√£o)
server:EnableCors()

-- Configura√ß√£o restrita
server:EnableCors{
  AllowOrigins = {"https://meuapp.com", "https://admin.meuapp.com"},
  AllowMethods = {"GET", "POST"},
  AllowHeaders = "Content-Type, Authorization",
  AllowCredentials = true,
  ExposeHeaders = {"X-Total-Count"},
  MaxAge = 3600
}
```

| Op√ß√£o | Tipo | Padr√£o |
|-------|------|--------|
| `AllowOrigins` | string \| string[] | `"*"` |
| `AllowMethods` | string \| string[] | `"GET, POST, PUT, DELETE, PATCH, OPTIONS"` |
| `AllowHeaders` | string \| string[] | `"Content-Type, Authorization"` |
| `ExposeHeaders` | string \| string[] | `""` |
| `AllowCredentials` | boolean | `false` |
| `MaxAge` | number | `86400` |

## Pipeline

O sistema de pipeline permite adicionar handlers de request/response que rodam antes dos handlers de rota. Cada handler recebe `(req, res, next)` ‚Äî chame `next()` para continuar ou retorne diretamente para interromper.

```lua
-- Logger de requisi√ß√µes
server:UseHandler{
  name = "logger",
  Handler = function(req, res, next)
    print(req.method .. " " .. req.path)
    return next()
  end
}

-- Autentica√ß√£o (interrompe em caso de falha)
server:UseHandler{
  name = "auth",
  Handler = function(req, res, next)
    if req.path:find("^/api/protected") and not req.headers["authorization"] then
      return res:response(401, {error = "N√£o autorizado"})
    end
    return next()
  end
}

-- Wrapper de resposta
server:UseHandler{
  name = "timer",
  Handler = function(req, res, next)
    local start = os.clock()
    local response = next()
    print(("Requisi√ß√£o levou %.3fs"):format(os.clock() - start))
    return response
  end
}

-- Remover um handler
server:RemoveHandler("logger")
```

Handlers rodam na ordem em que s√£o registrados. O handler de rota roda por √∫ltimo.

## Cache

Cache de respostas em mem√≥ria com TTL e eviction autom√°tica. Apenas requisi√ß√µes `GET` s√£o cacheadas.

```lua
local Cache = require("PudimServer.cache")

-- Criar inst√¢ncia do cache
local cache = Cache.new{
  MaxSize = 200,     -- m√°ximo de entradas (padr√£o: 100)
  DefaultTTL = 120   -- segundos (padr√£o: 60)
}

-- Adicionar ao pipeline (forma mais f√°cil)
server:UseHandler(Cache.createPipelineHandler(cache))

-- Ou usar manualmente em uma rota
server:Routes("/api/data", function(req, res)
  local cached = cache:get("minha-chave")
  if cached then return cached end

  local response = res:response(200, {data = "computa√ß√£o pesada"})
  cache:set("minha-chave", response, 30) -- TTL customizado
  return response
end)

-- Invalidar entradas
cache:invalidate("minha-chave")
cache:clear()
```

| Op√ß√£o | Tipo | Padr√£o | Descri√ß√£o |
|-------|------|--------|-----------|
| `MaxSize` | number | `100` | M√°ximo de entradas antes da eviction |
| `DefaultTTL` | number | `60` | TTL em segundos |

## Exemplo Completo

```lua
local PudimServer = require("PudimServer")
local Cache = require("PudimServer.cache")

local server = PudimServer:Create{
  ServiceName = "Minha API",
  Port = 3000,
  Address = "localhost"
}

-- Habilitar CORS
server:EnableCors()

-- Logger de requisi√ß√µes
server:UseHandler{
  name = "logger",
  Handler = function(req, res, next)
    print(("[%s] %s %s"):format(os.date("%H:%M:%S"), req.method, req.path))
    return next()
  end
}

-- Cache (apenas GET, TTL de 30s)
local cache = Cache.new{ DefaultTTL = 30 }
server:UseHandler(Cache.createPipelineHandler(cache))

-- Rotas
server:Routes("/", function(req, res)
  if req.method == "GET" then
    return res:response(200, "<h1>Bem-vindo!</h1>", {["Content-Type"] = "text/html"})
  end
  return res:response(405, {error = "M√©todo n√£o permitido"})
end)

server:Routes("/api/data", function(req, res)
  if req.method == "GET" then
    return res:response(200, {
      status = "ok",
      timestamp = os.time(),
      message = "API funcionando!"
    })
  end
  return res:response(405, {error = "M√©todo n√£o permitido"})
end)

print("Servidor rodando em http://localhost:3000")
server:Run()
```

## Exemplos

Exemplos funcionais est√£o dispon√≠veis no diret√≥rio [`examples/`](examples/):

| Arquivo | Descri√ß√£o |
|---------|-----------|
| [`json_response_example.lua`](examples/json_response_example.lua) | Auto encoding de tabelas para JSON |
| [`cors_example.lua`](examples/cors_example.lua) | CORS com configura√ß√£o padr√£o |
| [`cors_restricted_example.lua`](examples/cors_restricted_example.lua) | CORS com origens restritas e credentials |
| [`pipeline_example.lua`](examples/pipeline_example.lua) | Logger, auth e header customizado no pipeline |
| [`cache_example.lua`](examples/cache_example.lua) | Cache via pipeline e cache manual |

Execute qualquer exemplo com:

```sh
lua ./examples/json_response_example.lua
```

## Roadmap

> [!NOTE]
> Este projeto est√° em fase experimental. Confira abaixo o que j√° foi implementado e o que est√° planejado.

### ‚úÖ Implementado

- [x] Sistema de rotas b√°sico
- [x] Parsing de requisi√ß√µes HTTP (method, path, headers, body)
- [x] Respostas JSON autom√°ticas (tables convertidas para JSON)
- [x] Sistema de logs configur√°vel
- [x] CORS helpers (Cross-Origin Resource Sharing)
- [x] Pipeline de request/response (middleware no n√≠vel HTTP)
- [x] Cache de respostas em mem√≥ria com TTL

### üìã Planejado

- [ ] Rotas din√¢micas com par√¢metros (`/users/:id`, `/posts/:slug`)
- [ ] Parsing autom√°tico de query strings (`?page=1&limit=10`)
- [ ] Mais c√≥digos de status HTTP mapeados
- [ ] Suporte a uploads de arquivos (multipart/form-data)
- [ ] Servir arquivos est√°ticos (HTML, CSS, JS, imagens)
- [ ] Rate limiting b√°sico

### üîÆ Futuro (talvez)

- [ ] Suporte a WebSockets
- [ ] Multi-threading / concorr√™ncia
- [ ] HTTPS nativo (sem precisar de wrapper externo)
- [ ] Hot reload em desenvolvimento
- [ ] CLI para criar projetos

## Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo [LICENSE](LICENSE) para mais detalhes.

## Contribuindo

Contribui√ß√µes s√£o bem-vindas! Veja o guia completo em [CONTRIBUTING_PT-BR.MD](CONTRIBUTING_PT-BR.MD).

---

Feito com ‚ù§Ô∏è por [Davi](https://github.com/pessoa736)
